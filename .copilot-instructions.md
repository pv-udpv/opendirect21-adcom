# Copilot Instructions for OpenDirect 2.1 + Adcom v1.0 Development

## Project Context

This is a FastAPI-based REST API server for OpenDirect 2.1 and Adcom v1.0 specifications (IAB standards for programmatic media trading).

**Key Stack**: Python 3.12+, FastAPI, Pydantic v2, Uvicorn, pytest, Docker

## Primary Tasks

### 1. OpenDirect 2.1 Parser Implementation

**Goal**: Parse OpenDirect 2.1 markdown specification and auto-generate Pydantic models

**File**: `tools/spec_parser/md_tables.py` (already started)

**Requirements**:
- Extract 20+ objects from markdown tables (Attribute | Description | Type)
- Parse enum values (e.g., "enum (Active, Inactive)")
- Determine required/optional fields
- Handle nested objects and arrays
- Type mapping: string â†’ str, integer â†’ int, enum â†’ Enum, etc.

**Priority Objects**:
1. Organization, Account, Order, Line, Creative, Assignment
2. Product, Contact, AdvertiserBrand, Address, AdUnit
3. Message, Placement, CustomProperty

### 2. Pydantic Model Generation

**Goal**: Generate production-ready Pydantic BaseModel classes

**File**: `tools/spec_parser/gen_models.py` (skeleton provided)

**Requirements**:
- Input: ObjectDef list from parser
- Output: Python files with Pydantic models
- Include docstrings from spec descriptions
- Add Field validators with constraints
- Support Optional/List types
- Generate Enum classes for enum fields

**Output Location**: `opendirect21/models/generated/opendirect.py`

### 3. FastAPI Router Generation

**Goal**: Auto-generate CRUD endpoints for all models

**File**: `tools/spec_parser/gen_routes.py` (skeleton provided)

**Requirements**:
- Generate GET /resource (list with pagination)
- Generate GET /resource/{id}
- Generate POST /resource (create)
- Generate PUT /resource/{id} (update)
- Generate DELETE /resource/{id}
- Support nested resources (e.g., /orders/{order_id}/lines)
- Include proper error handling (404, 400, 500)
- Type hints and docstrings

**Output Location**: `opendirect21/api/generated/opendirect_routes.py`

### 4. Adcom v1.0 Parser Implementation

**Goal**: Parse Adcom v1.0 specification (similar to OpenDirect but different structure)

**File**: `tools/spec_parser/adcom_parser.py` (to create)

**Requirements**:
- Parse Adcom objects (Ad, Display, Banner, Video, Audio, Native)
- Parse Asset types (LinkAsset, ImageAsset, VideoAsset, TitleAsset, DataAsset)
- Parse Context objects (Publisher, Content, User, Device, Geo)
- Extract enum definitions from "List:" sections
- Handle different markdown formatting

**Priority Objects**:
1. Ad, Display, Banner, Video, Audio, Native
2. Asset, LinkAsset, ImageAsset, VideoAsset, TitleAsset, DataAsset
3. Publisher, Content, User, Device, Geo

### 5. Testing

**Files**: 
- `tests/test_health.py` (done)
- `tests/test_store.py` (done)
- `tests/test_api.py` (to expand)
- `tools/spec_parser/smoke_test.py` (to enhance)

**Requirements**:
- Test all parser functions
- Test all model generation
- Test all API endpoints
- Test error cases (404, 400, validation)
- Test pagination
- Achieve 80%+ code coverage

## Code Standards

### Python Style
- Python 3.12+ features (type hints, f-strings, walrus operator)
- PEP 8 compliance (100 char line length)
- Type hints on all functions
- Docstrings in Google format
- No unused imports
- Use `async`/`await` throughout

### Naming Conventions
- Models: PascalCase (e.g., `Organization`, `OrderStatus`)
- Functions: snake_case (e.g., `extract_objects`, `generate_model_code`)
- Constants: UPPER_CASE (e.g., `MAX_PAGE_SIZE`)
- Private methods: _snake_case (e.g., `_parse_body`)

### Testing Conventions
- Test file name: `test_*.py`
- Test function name: `test_*`
- Use `@pytest.mark.asyncio` for async tests
- Use fixtures from `tests/conftest.py`
- Arrange-Act-Assert pattern

### Error Handling
```python
# Use HTTPException for API errors
from fastapi import HTTPException

raise HTTPException(
    status_code=404,
    detail="Organization not found"
)

# Use custom exceptions for parser errors
class ParserError(Exception):
    """Base parser exception"""
    pass
```

### Type Hints
```python
from typing import Optional, List, Dict, Any, Tuple
from datetime import datetime

async def create_object(
    entity_type: str, 
    data: Dict[str, Any]
) -> Dict[str, Any]:
    """Create entity and return with generated ID."""
    ...
```

## File Structure Guidelines

### Module Organization
```
tool/function.py          # Single responsibility
  - Imports (stdlib, external, local)
  - Constants
  - Classes
  - Functions
  - if __name__ == "__main__":
```

### Class Organization
```
class ClassName:
    """Docstring."""
    
    def __init__(self):
        pass
    
    async def public_method(self):
        """Public method."""
        return self._private_method()
    
    def _private_method(self):
        """Private helper method."""
        pass
```

## Data Flow

### Parser Flow
```
Markdown File
    â†“
MarkdownTableParser.extract_objects()
    â†“
List[ObjectDef]  # (name, fields, type)
    â†“
PydanticGenerator.generate_model_code()
    â†“
Python Files (opendirect21/models/generated/*.py)
```

### API Flow
```
Client Request (HTTP)
    â†“
FastAPI Route Handler (async)
    â†“
Pydantic Validation
    â†“
Store.get/create/update/delete (async)
    â†“
JSON Response
```

## Key Files

| File | Purpose | Status |
|------|---------|--------|
| `tools/spec_parser/md_tables.py` | Markdown parser base | âœ… Started |
| `tools/spec_parser/gen_models.py` | Model generator | â³ In progress |
| `tools/spec_parser/gen_routes.py` | Router generator | â³ In progress |
| `tools/spec_parser/adcom_parser.py` | Adcom parser | ðŸ”² To create |
| `opendirect21/models/generated/opendirect.py` | Generated models | ðŸ”² Auto-generated |
| `opendirect21/models/generated/adcom.py` | Adcom models | ðŸ”² Auto-generated |
| `opendirect21/api/generated/opendirect_routes.py` | Generated routes | ðŸ”² Auto-generated |
| `tests/test_api.py` | API endpoint tests | â³ To expand |
| `tests/test_store.py` | Store tests | âœ… Done |

## Common Patterns

### Async Context Manager
```python
@asynccontextmanager
async def lifespan(app: FastAPI):
    # Startup
    logger.info("Starting up")
    yield
    # Shutdown
    logger.info("Shutting down")
```

### Pydantic Model
```python
class Organization(BaseModel):
    """Organization in the system."""
    id: str = Field(description="UUID")
    name: str = Field(description="Display name")
    type: Literal["Publisher", "Buyer"] = Field(description="Type")
```

### FastAPI Route
```python
@router.get("/organizations/{org_id}")
async def get_organization(org_id: str) -> Organization:
    """Get organization by ID."""
    org = await store.get("organizations", org_id)
    if not org:
        raise HTTPException(status_code=404, detail="Not found")
    return Organization(**org)
```

### Test Case
```python
@pytest.mark.asyncio
async def test_get_organization(client: AsyncClient):
    """Test getting organization."""
    response = await client.get("/organizations/org-123")
    assert response.status_code == 200
    assert response.json()["name"] is not None
```

## Development Workflow

1. **Read spec files** into parser
2. **Parse objects** from markdown tables
3. **Generate models** as Pydantic classes
4. **Generate routes** as FastAPI endpoints
5. **Write tests** for each component
6. **Run tests**: `pytest tests/ -v`
7. **Format code**: `black opendirect21 tools tests`
8. **Lint**: `ruff check opendirect21 tools tests`
9. **Commit**: `git commit -m "feat: description"`
10. **Push**: `git push origin main`

## Environment

```bash
# Setup
python3.12 -m venv venv
source venv/bin/activate
pip install -r requirements.txt

# Run tests
pytest tests/ -v --cov=opendirect21

# Run server
python -m opendirect21.main

# Format
black opendirect21 tools tests

# Lint
ruff check opendirect21 tools tests
```

## Resources

- FastAPI Docs: https://fastapi.tiangolo.com
- Pydantic Docs: https://docs.pydantic.dev
- OpenDirect 2.1 Spec: https://github.com/InteractiveAdvertisingBureau/OpenDirect
- Adcom v1.0 Spec: https://github.com/InteractiveAdvertisingBureau/AdCOM
- IAB Tech Lab: https://iabtechlab.com

## Contact

For questions or issues, check GitHub issues or documentation.
